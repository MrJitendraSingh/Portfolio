name: Deploy Portfolio to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: List available Gradle tasks
        run: ./gradlew tasks --all | grep -i "wasm\|browser" | head -20 || echo "Could not list tasks"

      - name: Build Web Application (Wasm)
        run: |
          # Try different task names
          if ./gradlew :composeApp:wasmJsBrowserProductionWebpack --dry-run 2>&1 | grep -q "wasmJsBrowserProductionWebpack"; then
            ./gradlew :composeApp:wasmJsBrowserProductionWebpack
          elif ./gradlew :composeApp:wasmJsBrowserProductionDistribution --dry-run 2>&1 | grep -q "wasmJsBrowserProductionDistribution"; then
            ./gradlew :composeApp:wasmJsBrowserProductionDistribution
          elif ./gradlew :composeApp:wasmJsBrowserProductionExecutable --dry-run 2>&1 | grep -q "wasmJsBrowserProductionExecutable"; then
            ./gradlew :composeApp:wasmJsBrowserProductionExecutable
          else
            echo "Trying default wasmJs build..."
            ./gradlew :composeApp:wasmJsBrowserProductionWebpack || ./gradlew :composeApp:wasmJsBrowserProductionDistribution || ./gradlew :composeApp:wasmJsBrowserProductionExecutable
          fi

      - name: Find and prepare build output
        id: find_output
        run: |
          echo "Searching for build output..."
          echo "Current directory structure:"
          find composeApp/build -type d -maxdepth 4 2>/dev/null | head -20 || true
          
          # Try to find the build output directory
          OUTPUT_DIR=""
          for dir in \
            "composeApp/build/kotlin-webpack/wasmJs/productionExecutable" \
            "composeApp/build/dist/wasmJs/productionExecutable" \
            "composeApp/build/dist/wasmJs/production" \
            "composeApp/build/dist/wasmJs" \
            "composeApp/build/dist" \
            "composeApp/build/wasmJs/productionExecutable" \
            "composeApp/build/wasmJs/production"
          do
            if [ -d "$dir" ] 2>/dev/null; then
              # Check if directory has wasm/js files (index.html might be in processedResources)
              WASM_COUNT=$(find "$dir" -maxdepth 1 -name "*.wasm" -type f 2>/dev/null | wc -l)
              JS_COUNT=$(find "$dir" -maxdepth 1 -name "*.js" -type f 2>/dev/null | wc -l)
              HAS_HTML=$([ -f "$dir/index.html" ] 2>/dev/null && echo "1" || echo "0")
              
              if [ "$WASM_COUNT" -gt 0 ] || [ "$JS_COUNT" -gt 0 ] || [ "$HAS_HTML" = "1" ]; then
                OUTPUT_DIR="$dir"
                echo "Found build output at: $OUTPUT_DIR"
                echo "  - WASM files: $WASM_COUNT"
                echo "  - JS files: $JS_COUNT"
                echo "  - Has index.html: $HAS_HTML"
                break
              fi
            fi
          done
          
          if [ -z "$OUTPUT_DIR" ]; then
            echo "Build output not found. Searching for HTML files:"
            find composeApp/build -name "*.html" -type f 2>/dev/null | head -5
            find composeApp/build -name "*.wasm" -type f 2>/dev/null | head -5
            echo "Trying to find any dist directory:"
            find composeApp/build -type d -name "dist" 2>/dev/null
            exit 1
          fi
          
          # Copy index.html from processedResources if it doesn't exist in output dir
          if [ ! -f "$OUTPUT_DIR/index.html" ]; then
            echo "index.html not found in output directory, looking for it..."
            HTML_SOURCE=$(find composeApp/build/processedResources/wasmJs/main -name "index.html" 2>/dev/null | head -1)
            if [ -n "$HTML_SOURCE" ]; then
              echo "Copying index.html from $HTML_SOURCE"
              cp "$HTML_SOURCE" "$OUTPUT_DIR/"
            fi
          fi
          
          # Copy styles.css if it doesn't exist
          if [ ! -f "$OUTPUT_DIR/styles.css" ]; then
            CSS_SOURCE=$(find composeApp/build/processedResources/wasmJs/main -name "styles.css" 2>/dev/null | head -1)
            if [ -n "$CSS_SOURCE" ]; then
              echo "Copying styles.css from $CSS_SOURCE"
              cp "$CSS_SOURCE" "$OUTPUT_DIR/"
            fi
          fi
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_OUTPUT
          echo "Contents of output directory:"
          ls -la "$OUTPUT_DIR"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.find_output.outputs.OUTPUT_DIR }}

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

